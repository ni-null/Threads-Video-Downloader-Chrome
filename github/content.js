(()=>{(function(){"use strict";if(!window.ThreadsDownloaderUtils||!window.ThreadsMediaExtractor||!window.ThreadsDownloaderButton||!window.ThreadsDownloaderOverlay){console.error("[Threads Downloader] \u6A21\u7D44\u8F09\u5165\u5931\u6557\uFF0C\u8ACB\u6AA2\u67E5 manifest.json \u4E2D\u7684\u8F09\u5165\u9806\u5E8F");return}const{logDebug:b,DOMObserver:o}=window.ThreadsDownloaderUtils,{addDownloadButtons:i}=window.ThreadsDownloaderButton,{addMediaOverlayButtons:r}=window.ThreadsDownloaderOverlay;let e={enableMediaMenu:!0,enableSingleDownload:!0,enableFilenamePrefix:!0,debugMode:!1,language:"auto"};async function l(){await window.ThreadsDownloaderUtils.initLanguage(),chrome.storage.local.get(["enableMediaMenu","enableSingleDownload","enableFilenamePrefix","debugMode","language"],n=>{e.enableMediaMenu=n.enableMediaMenu!==!1,e.enableSingleDownload=n.enableSingleDownload!==!1,e.enableFilenamePrefix=n.enableFilenamePrefix!==!1,e.debugMode=n.debugMode===!0,e.language=n.language||"auto",window.ThreadsDownloaderUtils&&(window.ThreadsDownloaderUtils._debugMode=e.debugMode),window.ThreadsDownloaderButton&&(window.ThreadsDownloaderButton._debugMode=e.debugMode,window.ThreadsDownloaderButton._enableFilenamePrefix=e.enableFilenamePrefix),window.ThreadsDownloaderOverlay&&(window.ThreadsDownloaderOverlay._debugMode=e.debugMode,window.ThreadsDownloaderOverlay._enableFilenamePrefix=e.enableFilenamePrefix),t()})}function t(){document.querySelectorAll(".threads-download-btn").forEach(a=>{a.style.display=e.enableMediaMenu?"":"none"}),document.querySelectorAll(".threads-overlay-btn").forEach(a=>{a.style.display=e.enableSingleDownload?"":"none"})}chrome.runtime.onMessage.addListener((n,h,a)=>(n.action==="updateSettings"&&(e=n.settings,n.settings.language!==void 0&&window.ThreadsDownloaderUtils.initLanguage().then(()=>{}),window.ThreadsDownloaderUtils&&(window.ThreadsDownloaderUtils._debugMode=e.debugMode===!0),window.ThreadsDownloaderButton&&(window.ThreadsDownloaderButton._debugMode=e.debugMode===!0,window.ThreadsDownloaderButton._enableFilenamePrefix=e.enableFilenamePrefix!==!1),window.ThreadsDownloaderOverlay&&(window.ThreadsDownloaderOverlay._debugMode=e.debugMode===!0,window.ThreadsDownloaderOverlay._enableFilenamePrefix=e.enableFilenamePrefix!==!1),t(),a({success:!0})),!0)),l();let d={totalProcessCalls:0,lastProcessTime:null};function s(n){d.totalProcessCalls++,d.lastProcessTime=new Date().toISOString(),!(window.ThreadsDownloaderButton&&window.ThreadsDownloaderButton._contextInvalidated)&&(window.ThreadsDownloaderOverlay&&window.ThreadsDownloaderOverlay._contextInvalidated||(e.enableMediaMenu&&i(),e.enableSingleDownload&&r(),t()))}function w(n){}o.init({config:{throttleDelay:300,debounceDelay:150,initialDelay:1e3,intersectionThreshold:.1,intersectionRootMargin:"200px",enableDebugLog:!1},onDOMChange:s,onElementVisible:w}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&o.triggerProcess()}),document.addEventListener("transitionend",()=>{o.triggerProcess()},{passive:!0}),document.addEventListener("animationend",()=>{o.triggerProcess()},{passive:!0});const u=window.ThreadsDownloaderUtils.throttle(()=>{o.triggerProcess()},500);window.addEventListener("scroll",u,{passive:!0}),window.addEventListener("popstate",()=>{setTimeout(()=>{o.triggerProcess()},500)});const g=history.pushState,c=history.replaceState;history.pushState=function(...n){g.apply(this,n),setTimeout(()=>{o.triggerProcess()},500)},history.replaceState=function(...n){c.apply(this,n),setTimeout(()=>{o.triggerProcess()},500)},window.ThreadsDownloaderDebug={getStats:()=>d,triggerProcess:()=>o.triggerProcess(),stopObserver:()=>o.stop(),updateConfig:n=>o.updateConfig(n),isRunning:()=>o.isRunning()}})();})();
