(()=>{window.ThreadsDownloaderUtils=window.ThreadsDownloaderUtils||{};window.ThreadsDownloaderUtils._debugMode=!1;window.ThreadsDownloaderUtils._currentLanguage=null;window.ThreadsDownloaderUtils._messages=null;window.ThreadsDownloaderUtils.logDebug=function(e,n=null){window.ThreadsDownloaderUtils._debugMode};const h={"zh-TW":"zh_TW","zh-CN":"zh_CN","zh-HK":"zh_TW","zh-SG":"zh_CN",ja:"ja","ja-JP":"ja",ko:"ko","ko-KR":"ko",en:"en","en-US":"en","en-GB":"en"};window.ThreadsDownloaderUtils.initLanguage=async function(){return new Promise(e=>{chrome.storage.local.get(["language","debugMode"],async n=>{window.ThreadsDownloaderUtils._debugMode=n.debugMode===!0;const t=n.language||"auto";let o=null;if(t==="auto"){const i=chrome.i18n.getUILanguage();o=h[i]||"en"}else o=t;window.ThreadsDownloaderUtils._currentLanguage=o;try{const i=await fetch(chrome.runtime.getURL(`_locales/${o}/messages.json`));window.ThreadsDownloaderUtils._messages=await i.json()}catch(i){console.error("\u7121\u6CD5\u8F09\u5165\u8A9E\u8A00\u6A94\u6848:",i),window.ThreadsDownloaderUtils._messages=null}e()})})};window.ThreadsDownloaderUtils.i18n=function(e,n=null){try{if(window.ThreadsDownloaderUtils._messages&&window.ThreadsDownloaderUtils._messages[e]){const t=window.ThreadsDownloaderUtils._messages[e];let o=t.message;if(n&&t.placeholders){const i=Array.isArray(n)?n:[n];Object.keys(t.placeholders).forEach(r=>{const d=t.placeholders[r].content.match(/\$(\d+)/);if(d){const l=parseInt(d[1])-1;if(l>=0&&l<i.length){const c=`\\$${r.toUpperCase()}\\$`;o=o.replace(new RegExp(c,"gi"),i[l])}}})}return o}if(chrome&&chrome.i18n&&chrome.i18n.getMessage)return chrome.i18n.getMessage(e,n)||e}catch(t){console.error("i18n error:",t)}return e};window.ThreadsDownloaderUtils.getUILanguage=function(){try{if(chrome&&chrome.i18n&&chrome.i18n.getUILanguage)return chrome.i18n.getUILanguage()}catch{}return navigator.language||"en"};window.ThreadsDownloaderUtils.showPageNotification=function(e){const n=document.querySelector(".threads-download-notification");n&&n.remove();const t=document.createElement("div");t.className="threads-download-notification",t.innerHTML=e,t.style.cssText=`
    position: fixed;
    top: 20px;
    right: 20px;
    background: #333;
    color: #fff;
    padding: 12px 20px;
    border-radius: 8px;
    z-index: 100000;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  `;const o=document.createElement("style");o.textContent=`
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  `,document.querySelector("style[data-threads-download]")||(o.setAttribute("data-threads-download","true"),document.head.appendChild(o)),document.body.appendChild(t),setTimeout(()=>{t.style.opacity="0",t.style.transition="opacity 0.3s",setTimeout(()=>t.remove(),300)},3e3)};window.ThreadsDownloaderUtils.findPostInfoFromElement=function(e){if(!e)return null;let n=e,t=0;const o=15;for(;n&&t<o;){const i=n.querySelectorAll?n.querySelectorAll('a[href*="/post/"]'):[];for(const r of i){const s=r.href,a=window.ThreadsDownloaderUtils.parseThreadsUrl(s);if(a)return a}n=n.parentElement,t++}return window.ThreadsDownloaderUtils.parseThreadsUrl(window.location.href)};window.ThreadsDownloaderUtils.parseThreadsUrl=function(e){if(!e)return null;try{const n=e.match(/@([^/]+)\/post\/([^/?#]+)/);if(n)return{username:n[1],postId:n[2],url:e}}catch{}return null};window.ThreadsDownloaderUtils.throttle=function(e,n){let t=null,o=0;return function(...i){const r=Date.now(),s=n-(r-o);s<=0||s>n?(t&&(clearTimeout(t),t=null),o=r,e.apply(this,i)):t||(t=setTimeout(()=>{o=Date.now(),t=null,e.apply(this,i)},s))}};window.ThreadsDownloaderUtils.debounce=function(e,n){let t=null;return function(...o){t&&clearTimeout(t),t=setTimeout(()=>{t=null,e.apply(this,o)},n)}};window.ThreadsDownloaderUtils.DOMObserver={mutationObserver:null,intersectionObserver:null,config:{throttleDelay:300,debounceDelay:150,initialDelay:1e3,intersectionThreshold:.1,intersectionRootMargin:"200px",enableDebugLog:!1},_onDOMChangeCallback:null,_onElementVisibleCallback:null,_throttledHandler:null,_debouncedHandler:null,_pendingElements:new Set,_isRunning:!1,init:function(e={}){const{logDebug:n}=window.ThreadsDownloaderUtils;this._isRunning||(e.config&&(this.config={...this.config,...e.config}),this._onDOMChangeCallback=e.onDOMChange||null,this._onElementVisibleCallback=e.onElementVisible||null,this._throttledHandler=window.ThreadsDownloaderUtils.throttle(this._processDOMChanges.bind(this),this.config.throttleDelay),this._debouncedHandler=window.ThreadsDownloaderUtils.debounce(this._processDOMChanges.bind(this),this.config.debounceDelay),setTimeout(()=>{this._initMutationObserver(),this._initIntersectionObserver(),this._isRunning=!0,this._onDOMChangeCallback&&this._onDOMChangeCallback({type:"initial"})},this.config.initialDelay))},_initMutationObserver:function(){const{logDebug:e}=window.ThreadsDownloaderUtils;this.mutationObserver&&this.mutationObserver.disconnect(),this.mutationObserver=new MutationObserver(n=>{let t=!1;for(const o of n){if(o.type==="childList"&&o.addedNodes.length>0){for(const i of o.addedNodes)if(i.nodeType===Node.ELEMENT_NODE&&this._isRelevantNode(i)){t=!0;break}}if(t)break}t&&(this.config.enableDebugLog,this._debouncedHandler())}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1})},_initIntersectionObserver:function(){this.intersectionObserver&&this.intersectionObserver.disconnect(),this.intersectionObserver=new IntersectionObserver(e=>{for(const n of e)n.isIntersecting&&(this._onElementVisibleCallback&&this._onElementVisibleCallback(n.target),this.intersectionObserver.unobserve(n.target))},{threshold:this.config.intersectionThreshold,rootMargin:this.config.intersectionRootMargin})},_isRelevantNode:function(e){return!!(e.tagName==="VIDEO"||e.tagName==="PICTURE"||e.tagName==="IMG"||e.querySelector&&(e.querySelector("video, picture, img")||e.querySelector('a[href*="/post/"]')))},_processDOMChanges:function(){this._onDOMChangeCallback&&this._onDOMChangeCallback({type:"mutation"})},observeElement:function(e){this.intersectionObserver&&e&&this.intersectionObserver.observe(e)},triggerProcess:function(){this._throttledHandler()},stop:function(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null),this._isRunning=!1},updateConfig:function(e){this.config={...this.config,...e},this._isRunning&&(this._throttledHandler=window.ThreadsDownloaderUtils.throttle(this._processDOMChanges.bind(this),this.config.throttleDelay),this._debouncedHandler=window.ThreadsDownloaderUtils.debounce(this._processDOMChanges.bind(this),this.config.debounceDelay))},isRunning:function(){return this._isRunning}};})();
