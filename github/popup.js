(()=>{document.addEventListener("DOMContentLoaded",async()=>{const b=(await new Promise(e=>{chrome.storage.local.get(["enableMediaMenu","enableSingleDownload","language","debugMode"],n=>{e(n)})})).language||"auto";await m(b==="auto"?null:b);const s=document.getElementById("languageSelect"),d=document.getElementById("enableMediaMenu"),i=document.getElementById("enableSingleDownload"),u=document.getElementById("enableFilenamePrefix"),r=document.getElementById("enableDebugMode");function f(e,n=null){const t="[DEBUG-POPUP] "+e+(n?" "+JSON.stringify(n):"")}async function m(e=null){const n={"zh-TW":"zh_TW","zh-CN":"zh_CN","zh-HK":"zh_TW","zh-SG":"zh_CN",ja:"ja","ja-JP":"ja",ko:"ko","ko-KR":"ko",en:"en","en-US":"en","en-GB":"en"};let t=e;if(!t){const o=chrome.i18n.getUILanguage();t=n[o]||"en"}try{const a=await(await fetch(chrome.runtime.getURL(`_locales/${t}/messages.json`))).json();document.querySelectorAll("[data-i18n]").forEach(l=>{const c=l.getAttribute("data-i18n");a[c]&&a[c].message&&(l.textContent=a[c].message)})}catch(o){console.error("Failed to load language:",o),document.querySelectorAll("[data-i18n]").forEach(a=>{const l=a.getAttribute("data-i18n"),c=chrome.i18n.getMessage(l);c&&(a.textContent=c)})}}function h(){chrome.storage.local.get(["enableMediaMenu","enableSingleDownload","enableFilenamePrefix","language","debugMode"],e=>{const n=e.enableMediaMenu!==!1,t=e.enableSingleDownload!==!1,o=e.enableFilenamePrefix!==!1,a=e.debugMode===!0,l=e.language||"auto";d.checked=n,i.checked=t,u.checked=o,r.checked=a,s.value=l})}function g(){const e={enableMediaMenu:d.checked,enableSingleDownload:i.checked,enableFilenamePrefix:u.checked,debugMode:r.checked,language:s.value};chrome.storage.local.set(e,()=>{chrome.tabs.query({active:!0,currentWindow:!0},n=>{n[0]&&chrome.tabs.sendMessage(n[0].id,{action:"updateSettings",settings:e},t=>{chrome.runtime.lastError})})})}d.addEventListener("change",g),i.addEventListener("change",g),u.addEventListener("change",g),r.addEventListener("change",g),s.addEventListener("change",async()=>{g();const e=s.value;await m(e==="auto"?null:e)}),h()});})();
